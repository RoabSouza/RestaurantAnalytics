<!-- Template principal do dashboard COM DRAG & DROP -->
<div class="dashboard-container">

  <!-- CabeÃ§alho do dashboard -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo-container">
        <img src="../../../assets/abacate.png" alt="Abacate">
        <h1>AvocaDash</h1>
      </div>

      <div class="header-actions">

        <!-- BotÃµes de teste (apenas desenvolvimento) 
        <div class="test-buttons" *ngIf="!loading && !error">
          <button class="btn-test" (click)="simularMudancaDeDados()" title="Testar reatividade dos grÃ¡ficos">
            ğŸ§ª Testar
          </button>
          <button class="btn-test" (click)="adicionarCanalAleatorio()" title="Adicionar canal aleatÃ³rio">
            â• Canal
          </button>
        </div>-->


        <button class="btn-export-pdf" (click)="abrirModalExport()">
          ğŸ“„ Exportar PDF
        </button>

        <!-- BotÃ£o para alternar modo de ediÃ§Ã£o -->
        <button class="btn-edit-layout" (click)="toggleModoEdicao()" [class.active]="modoEdicao">
          {{ modoEdicao ? 'ğŸ’¾ Salvar Layout' : 'âœï¸ Personalizar' }}
        </button>

        <button class="btn-refresh" (click)="recarregar()" [disabled]="loading">
          ğŸ”„ Atualizar
        </button>
        <app-theme-toggle></app-theme-toggle>
      </div>
    </div>
  </header>

  <!-- Mensagem do modo de ediÃ§Ã£o -->
  <div *ngIf="modoEdicao" class="edit-mode-banner">
    <p>ğŸ¯ Modo de PersonalizaÃ§Ã£o: Arraste os elementos para reorganizar o dashboard</p>
  </div>

  <!-- SeÃ§Ã£o de filtros por data -->
  <section class="filters-section" *ngIf="!loading">
    <app-date-filter (filtroAplicado)="aplicarFiltros($event)"></app-date-filter>
  </section>

  <!-- Estado de carregamento -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Carregando dados...</p>
  </div>

  <!-- Estado de erro -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">âš ï¸</div>
    <h2>Ops! Algo deu errado</h2>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="recarregar()">
      Tentar Novamente
    </button>
  </div>

  <!-- CONTEÃšDO PRINCIPAL COM DRAG & DROP -->
  <div *ngIf="dashboardData && !loading && !error" class="dashboard-content" cdkDropListGroup>

    <!-- Container principal das seÃ§Ãµes arrastÃ¡veis -->
    <div cdkDropList [cdkDropListData]="ordemSecoes" (cdkDropListDropped)="reordenarSecoes($event)"
      class="sections-container">

      <!-- Loop pelas seÃ§Ãµes na ordem definida -->
      <section *ngFor="let secao of ordemSecoes" [cdkDragData]="secao" cdkDrag [cdkDragDisabled]="!modoEdicao"
        class="dashboard-section">

        <!-- ConteÃºdo da seÃ§Ã£o baseado no tipo -->
        <ng-container [ngSwitch]="secao">

          <!-- SEÃ‡ÃƒO: INSIGHTS COMPARATIVOS -->
          <div *ngSwitchCase="'insights'" class="section-content">
            <div class="section-header">
              <div class="section-actions">
                <div *ngIf="modoEdicao" class="drag-handle" cdkDragHandle>
                  â‹®â‹®
                </div>
                <button *ngIf="modoEdicao" class="btn-remove-section" (click)="removerSecao('insights')">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
            <app-insights-panel 
              [dadosAtuais]="dashboardData"
              [dataInicio]="dataInicio"
              [dataFim]="dataFim">
            </app-insights-panel>
          </div>

          <!-- SEÃ‡ÃƒO: MÃ‰TRICAS PRINCIPAIS COM DRAG & DROP INTERNO -->
          <div *ngSwitchCase="'metrics'" class="section-content">
            <div class="section-header">
              <h2>ğŸ“Š MÃ©tricas Principais</h2>
              <div class="section-actions">
                <div *ngIf="modoEdicao" class="drag-handle" cdkDragHandle>
                  â‹®â‹®
                </div>
                <button *ngIf="modoEdicao" class="btn-remove-section" (click)="removerSecao('metrics')">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>

            <!-- Grid de mÃ©tricas arrastÃ¡veis -->
            <div class="metrics-grid" cdkDropList [cdkDropListData]="ordemMetricas"
              (cdkDropListDropped)="reordenarMetricas($event)">

              <div *ngFor="let metrica of ordemMetricas" [cdkDragData]="metrica" cdkDrag [cdkDragDisabled]="!modoEdicao"
                class="metric-card">

                <div *ngIf="modoEdicao" class="metric-drag-handle" cdkDragHandle>
                  â‹®â‹®
                </div>

                <ng-container [ngSwitch]="metrica">
                  <!-- Card de Faturamento -->
                  <div *ngSwitchCase="'faturamento'" class="metric-card-content faturamento">
                    <div class="card-icon">ğŸ’°</div>
                    <div class="card-details">
                      <h3 class="card-label">Faturamento Total</h3>
                      <p class="card-value">{{ formatarMoeda(dashboardData.faturamentoTotal) }}</p>
                    </div>
                  </div>

                  <!-- Card de Total de Vendas -->
                  <div *ngSwitchCase="'vendas'" class="metric-card-content vendas">
                    <div class="card-icon">ğŸ›’</div>
                    <div class="card-details">
                      <h3 class="card-label">Total de Vendas</h3>
                      <p class="card-value">{{ formatarNumero(dashboardData.totalVendas) }}</p>
                    </div>
                  </div>

                  <!-- Card de Ticket MÃ©dio -->
                  <div *ngSwitchCase="'ticket'" class="metric-card-content ticket">
                    <div class="card-icon">ğŸ¯</div>
                    <div class="card-details">
                      <h3 class="card-label">Ticket MÃ©dio</h3>
                      <p class="card-value">{{ formatarMoeda(dashboardData.ticketMedio) }}</p>
                    </div>
                  </div>

                  <!-- Card de Crescimento -->
                  <div *ngSwitchCase="'crescimento'" class="metric-card-content crescimento"
                    [ngClass]="getClasseCrescimento()">
                    <div class="card-icon">{{ getIconeCrescimento() }}</div>
                    <div class="card-details">
                      <h3 class="card-label">Crescimento</h3>
                      <p class="card-value">
                        {{ dashboardData.crescimentoPercentual >= 0 ? '+' : '' }}{{
                        dashboardData.crescimentoPercentual.toFixed(2) }}%
                      </p>
                      <p class="card-subtitle">vs perÃ­odo anterior</p>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- SEÃ‡ÃƒO: GRÃFICOS EM GRID -->
          <div *ngSwitchCase="'chartsGrid'" class="section-content">
            <div class="section-header">
              <h2>ğŸ“ˆ AnÃ¡lises Visuais</h2>
              <div class="section-actions">
                <div *ngIf="modoEdicao" class="drag-handle" cdkDragHandle>
                  â‹®â‹®
                </div>
                <button *ngIf="modoEdicao" class="btn-remove-section" (click)="removerSecao('chartsGrid')">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>

            <!-- Grid de grÃ¡ficos arrastÃ¡veis -->
            <div class="charts-grid" cdkDropList [cdkDropListData]="ordemGraficos"
              (cdkDropListDropped)="reordenarGraficos($event)">

              <div *ngFor="let grafico of ordemGraficos" [cdkDragData]="grafico" cdkDrag [cdkDragDisabled]="!modoEdicao"
                class="chart-item">

                <div *ngIf="modoEdicao" class="chart-actions">
                  <div class="chart-drag-handle" cdkDragHandle>
                    â‹®â‹®
                  </div>
                </div>

                <ng-container [ngSwitch]="grafico">
                  <!-- GrÃ¡fico de Pizza -->
                  <app-sales-by-channel-chart *ngSwitchCase="'pizza'" [data]="dashboardData.vendasPorCanal">
                  </app-sales-by-channel-chart>

                  <!-- GrÃ¡fico de Barras -->
                  <app-sales-by-hour-chart *ngSwitchCase="'barras'" [data]="dashboardData.vendasPorHora">
                  </app-sales-by-hour-chart>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- SEÃ‡ÃƒO: GRÃFICO DE LINHA (FULL WIDTH) -->
          <div *ngSwitchCase="'timeline'" class="section-content">
            <div class="section-header">
              <h2>ğŸ“ˆ EvoluÃ§Ã£o Temporal</h2>
              <div class="section-actions">
                <div *ngIf="modoEdicao" class="drag-handle" cdkDragHandle>
                  â‹®â‹®
                </div>
                <button *ngIf="modoEdicao" class="btn-remove-section" (click)="removerSecao('timeline')">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
            <app-sales-timeline-chart [data]="dashboardData.vendasPorDia">
            </app-sales-timeline-chart>
          </div>

          <!-- SEÃ‡ÃƒO: TABELAS DE RANKING -->
          <div *ngSwitchCase="'tables'" class="section-content">
            <div class="section-header">
              <h2>ğŸ† Rankings</h2>
              <div class="section-actions">
                <div *ngIf="modoEdicao" class="drag-handle" cdkDragHandle>
                  â‹®â‹®
                </div>
                <button *ngIf="modoEdicao" class="btn-remove-section" (click)="removerSecao('tables')">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
            <app-top-tables [topProdutos]="dashboardData.topProdutos" [topLojas]="dashboardData.topLojas">
            </app-top-tables>
          </div>

        </ng-container>
      </section>

      <!-- BotÃ£o para adicionar seÃ§Ãµes (modo ediÃ§Ã£o) -->
      <div *ngIf="modoEdicao" class="add-section-placeholder">
        <button class="btn-add-section" (click)="mostrarModalSecoes()">
          + Adicionar SeÃ§Ã£o
        </button>
      </div>

    </div>

    <!-- SeÃ§Ã£o de debug (sempre no final) -->
    <section class="debug-section">
      <details>
        <summary>ğŸ› Debug: Ver dados da API</summary>
        <pre>{{ dashboardData | json }}</pre>
      </details>
    </section>

  </div>

  <!-- Modal para exportar PDF -->
  <app-export-pdf-modal></app-export-pdf-modal>

  <!-- Modal para adicionar seÃ§Ãµes -->
  <div *ngIf="mostrarModalAdicionarSecao" class="modal-overlay" (click)="fecharModalSecoes()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ¥‘ Adicionar SeÃ§Ã£o ao AvocaDash</h2>
        <button class="btn-close" (click)="fecharModalSecoes()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="secoes-disponiveis">
          <button *ngFor="let secao of secoesDisponiveis" class="btn-secao-option" (click)="adicionarSecao(secao.id)"
            [disabled]="ordemSecoes.includes(secao.id)">
            <span class="secao-icon">{{ secao.icon }}</span>
            <span class="secao-title">{{ secao.nome }}</span>
            <span class="secao-desc">{{ secao.descricao }}</span>
            <span *ngIf="ordemSecoes.includes(secao.id)" class="secao-adicionada">âœ“ Adicionada</span>
          </button>
        </div>
      </div>
    </div>
  </div>

</div>